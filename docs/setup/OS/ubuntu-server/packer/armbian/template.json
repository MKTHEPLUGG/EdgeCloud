{
  "variables": {
    "iso_url": "https://fi.mirror.armbian.de/dl/rock-5a/archive/Armbian_24.8.1_Rock-5a_noble_vendor_6.1.75_minimal.img.xz"
  },
  "builders": [
    {
      "type": "qemu",
      "iso_url": "{{user `iso_url`}}",
      "output_directory": "output-armbian-image",
      "disk_size": 20000,
      "format": "raw",
      "headless": true,
      "qemuargs": [["-m", "2048"]],
      "iso_checksum": "file:https://fi.mirror.armbian.de/dl/rock-5a/archive/Armbian_24.8.1_Rock-5a_noble_vendor_6.1.75_minimal.img.xz.sha",
      "ssh_username": "root",
      "ssh_password" : "1234"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "environment_vars": [
        "IMAGE_NAME=$(basename {{user `iso_url`}})"
      ],
      "inline": [
        "sudo apt-get update",
        "sudo apt-get install -y unxz",
        "unxz -v $IMAGE_NAME",
        "echo 'Decompression complete!'",
        "sudo cloud-init clean"
      ]
    },
    {
      "type": "file",
      "source": "cloud-config.yaml",
      "destination": "/etc/cloud/cloud.cfg.d/99_custom.cfg"
    }
  ],
  "post-processors": [
    {
      "type": "shell-local",
      "inline": [
        "qemu-img convert -O raw output-armbian-image/packer-qemu output-armbian-image/armbian-custom-image.raw"
      ]
    }
  ]
}
