# Storage (WIP)

in this section I will show you some ways to enhance the storage experience on our SBC's.

## USB NVME Adapter 

My personal favorite for its simplicity. I buy mine from [this](https://www.amazon.com.be/-/en/dp/B07ZNVK9K2?ref=ppx_yo2ov_dt_b_fed_asin_title) seller on amazon.
This method is supported on any device with an usb port. The main drawback of this method is the bottleneck generated by using usb instead of a native NVME port. However compared to a SD Card this solution still provides speeds up to 5 times higher.


You'll need to configure the board to boot from the ssd. We'll be using a sd card to boot afterwards we'll mount the ssd to serve as the main OS disk. In some cases the board might support booting straight to the SSD but I haven't seen this work yet.


### Boot Guide

This guide will walk you through the process of flashing an SD card with a linux image using a Linux operating system. It includes steps to clean the SD card, remove any existing partitions, prepare it as a single block, extract the `.xz` file, and flash the image.

### Step 1: Download the Image
1. **Find an image supported by your board, my personal favorites**:
   - [DietPi](https://dietpi.com).
   - [ARMBian](https://fi.mirror.armbian.de/dl/).
   - Download the appropriate DietPi image file for your device, usually provided as a compressed `.xz` file.


### Step 2: Extract the Image from the .xz File
1. **Extract the Image**:
   - Most images are provided as compressed `.xz` files. You need to extract the `.img` file before flashing it.
   - Use the `unxz` command to extract the image:
     ```bash
     unxz DietPi*.xz
     ```
   - Alternatively, you can use the `xz` command:
     ```bash
     xz -d DietPi*.xz
     ```
   - This will extract the `.img` file from the `.xz` archive, ready for flashing.

### Step 3: Prepare the SD Card
1. **Insert the SD Card into Your Computer**:
   - Insert the SD card into your computer using a card reader if necessary.
   - Determine the device path for the SD card by running:
     ```bash
     lsblk
     ```
   - Look for the device corresponding to your SD card (e.g., `/dev/sdX` or `/dev/mmcblkX`).

   **Important**: Make sure to correctly identify your SD card’s device path to avoid data loss.

2. **Remove Existing Partitions**:
   - If your SD card has been used previously, it might have multiple partitions. These need to be removed before flashing the image.
   - Use the `fdisk` utility to clean the SD card:
     ```bash
     sudo fdisk /dev/sdX
     ```
     Replace `/dev/sdX` with your SD card’s device path.
   - Within `fdisk`, follow these steps:
     - Press `p` to list the current partitions.
     - Press `d` to delete a partition. If there are multiple partitions, repeat this step until all are deleted.
     - Press `w` to write the changes and exit `fdisk`.

   This process will remove all existing partitions, leaving the SD card as one unallocated block of space.

3. **Create a New Partition Table (Optional)**:
   - If you want to create a new partition table to ensure the SD card is clean, you can do so:
     ```bash
     sudo fdisk /dev/sdX
     ```
   - Press `o` to create a new DOS partition table.
   - Press `w` to write the changes and exit.



### Step 4: Flash the Image to the SD Card

1. **Flash the Image**:
   - Use the `dd` command to write the DietPi image to the SD card:
     ```bash
     sudo dd if=/path/to/linux.img of=/dev/sdX bs=4M status=progress conv=fsync
     ```
   - **Explanation of Options**:
     - `if=/path/to/DietPi.img`: This specifies the input file (`if`) that you want to write to the SD card. Replace `/path/to/linux.img` with the path to your extracted DietPi image file.
     - `of=/dev/sdX`: This specifies the output file (`of`), which is the device path of your SD card. Replace `/dev/sdX` with the correct device path for your SD card.
     - `bs=4M`: The `bs` option sets the block size to 4 megabytes, which determines the amount of data written in each block. Using a larger block size can speed up the writing process.
     - `status=progress`: This option provides real-time progress updates, showing the amount of data written and the speed of the operation.
     - `conv=fsync`: This option ensures that all data is physically written to the SD card before the process completes. It forces `dd` to synchronize the data, reducing the risk of corruption if the SD card is removed too quickly after the command finishes.

2. **Wait for the Process to Complete**:
   - The `dd` command may take some time to complete, depending on the size of the image and the speed of your SD card.
   - Once finished, ensure the process is complete without errors.

3. **Sync the Data**:
   - Run the `sync` command to ensure all data has been written to the SD card:
     ```bash
     sudo sync
     ```
   - The `sync` command ensures that any remaining data in the buffer is fully written to the SD card, providing an additional layer of safety.


### Step 5: Safely Eject the SD Card
1. **Eject the SD Card**:
   - Safely eject the SD card from your computer:
     ```bash
     sudo eject /dev/sdX
     ```

### Step 6: Boot your image
1. **Insert the SD Card into Your Device**:
   - Insert the SD card into your device, such as a Raspberry Pi.

2. **Power On the Device**:
   - Power on your device. It should automatically boot from the SD card.

3. **Initial Setup**:
   - Follow the on-screen instructions to complete the initial setup.

### Troubleshooting Tips
- **Permission Denied Error**: Ensure you are using `sudo` with the `dd` command.
- **Incomplete Flash**: If the flashing process was interrupted, repeat the `dd` process after ensuring the SD card is unmounted.
- **Wrong Device Path**: Double-check the device path using `lsblk` before proceeding with the `dd` command.

### Additional Resources
- **DietPi Documentation**: For more detailed setup and configuration options, refer to the [DietPi documentation](https://dietpi.com/docs/).
- **ARMbian Documentation**: For more detailed setup and configuration options, refer to the [ARMbian documentation](https://docs.armbian.com/).


### Step 7 (optional): Configure Raspberry Pi to Boot from SSD

1. **Use `raspi-config` to Set Boot Order**:
   - Open the `raspi-config` tool:
     ```bash
     sudo apt install raspi-config
     sudo raspi-config
     ```
   - Navigate to `Advanced Options` (or `Boot Options`) and select `Boot Order`.
   - Set the boot order to prioritize USB boot. This ensures that the Raspberry Pi will attempt to boot from the SSD connected via USB first.

2. **Apply Changes and Reboot**:
   - After configuring the boot order, exit `raspi-config`, and reboot the Raspberry Pi:
     ```bash
     sudo reboot
     ```

3. **Verify the Bootloader Configuration**:
   - After rebooting, confirm that the bootloader configuration includes USB boot by running:
     ```bash
     sudo vcgencmd bootloader_config
     ```

### Step 8: Prepare to Migrate your install from the SD Card to the SSD

1. **Connect the SSD to the Raspberry Pi**:
   - Ensure the SSD is connected to your Raspberry Pi via a USB-to-SATA adapter or enclosure.

2. **Check Disk Configuration**:
   - List all connected storage devices to identify the SSD and SD card:
     ```bash
     lsblk
     ```
   - The SD card is typically `/dev/mmcblk0`, and the SSD might be `/dev/sda` or similar. Take note of these device names as they will be needed for the next steps.

### Step 9: Partition and Format the SSD

1. **Partition the SSD**:
   - Open the `fdisk` tool to create two partitions on the SSD: one for `/boot` and one for `/`.
     ```bash
     sudo fdisk /dev/sda
     ```
     Replace `/dev/sda` with your SSD's device path.
   - In `fdisk`, perform the following:
     - Press `n` to create a new partition.
     - Choose `p` for a primary partition.
     - For the first partition (which will be `/boot`):
       - Choose the default partition number (1).
       - Set the first sector to the default.
       - For the last sector, specify `+200M` to create a 200MB partition for `/boot`.
     - Press `n` again to create the second partition (which will be `/`):
       - Choose the default partition number (2).
       - Set the first sector to the default (which follows immediately after the `/boot` partition).
       - Accept the default for the last sector to use the remaining space for the root filesystem.
     - Press `w` to write the changes and exit `fdisk`.

2. **Format the Partitions**:
   - Format the first partition (`/dev/sda1`) as FAT32 for the `/boot` partition:
     ```bash
     sudo mkfs.vfat /dev/sda1
     ```
   - Format the second partition (`/dev/sda2`) as ext4 for the root (`/`) partition:
     ```bash
     sudo mkfs.ext4 /dev/sda2
     ```

### Step 10: Copy the Operating System to the SSD

1. **Mount the SSD Partitions**:
   - Create mount points for the SSD partitions and mount them:
     ```bash
     sudo mkdir /mnt/ssd_root
     sudo mkdir /mnt/ssd_boot
     sudo mount /dev/sda2 /mnt/ssd_root
     sudo mount /dev/sda1 /mnt/ssd_boot
     ```

2. **Copy the File System**:
   - Use the `rsync` command to copy the entire file system from the SD card to the SSD:
     ```bash
     sudo rsync -axv --progress / /mnt/ssd_root
     ```
   - Copy the contents of the `/boot` partition to the SSD’s `/boot` partition:
     ```bash
     sudo rsync -axv --progress /boot/ /mnt/ssd_boot
     ```

3. **Obtain the `PARTUUIDs` of the SSD Partitions**:
   - Run the following command to get the `PARTUUIDs` of the SSD partitions:
     ```bash
     sudo blkid /dev/sda1 /dev/sda2
     ```
   - The output will look something like this:
     ```
     /dev/sda1: UUID="ABCD-1234" TYPE="vfat" PARTUUID="12345678-01"
     /dev/sda2: UUID="abcd1234-5678-90ab-cdef-1234567890ab" TYPE="ext4" PARTUUID="12345678-02"
     ```

4. **Update the `fstab` on the SSD**:
   - Edit the `fstab` file on the SSD to use the correct `PARTUUIDs`:
     ```bash
     sudo nano /mnt/ssd_root/etc/fstab
     ```
   - Update the entries for the root (`/`) and boot (`/boot`) partitions:
     ```bash
     PARTUUID=12345678-02 / ext4 noatime,lazytime,rw 0 1
     PARTUUID=12345678-01 /boot vfat noatime,lazytime,rw 0 2
     ```
   - Replace `12345678-01` and `12345678-02` with the actual `PARTUUIDs` you obtained from the `blkid` command.

5. **Edit the Boot Configuration**:
   - Edit the `cmdline.txt` file on the SSD's boot partition to use the correct `PARTUUID` for the root partition:
     ```bash
     sudo nano /mnt/ssd_boot/cmdline.txt
     ```
   - Replace the `root=PARTUUID=...` entry with the `PARTUUID` of the SSD’s root partition:
     ```
     root=PARTUUID=12345678-02 rootfstype=ext4 rootwait
     ```
   - Save and exit the file.

6. **Reload `systemd` Configuration**:
   - Before or after editing the `fstab` on the SSD (if it’s mounted), reload `systemd` to ensure it recognizes any new or changed mount configurations:
     ```bash
     sudo systemctl daemon-reload
     ```
    

### Step 11: Verify Boot from SSD

1. **Check the Boot Device**:
   - Once the Raspberry Pi has booted, log in and verify that the system is running from the SSD:
     ```bash
     lsblk
     ```
   - Ensure that the root filesystem (`/`) is mounted from the SSD (`/dev/sda2` or equivalent).

2. **Clean Up**:
   - If everything is working correctly, you can repurpose or securely erase the SD card.

---

### Hybrid Setup - Boot from SD Card, Root on SSD

In this hybrid setup, the Raspberry Pi will use the SD card to boot but will then switch to the SSD for the root filesystem. This can provide faster boot times and reduce wear on the SD card.

#### 1. Prepare the SD Card

1. **Retain the Boot Partition on the SD Card**:
   - Leave the `/boot` partition on the SD card as it is. This partition contains the bootloader and other necessary files to start the boot process.

2. **Update the `cmdline.txt` on the SD Card**:
   - The `cmdline.txt` file on the SD card tells the bootloader where to find the root filesystem.
   - Open `cmdline.txt` for editing:
     ```bash
     sudo nano /boot/cmdline.txt
     ```
   - Modify the `root=` parameter to point to the SSD’s root partition using the `PARTUUID` you obtained earlier:
     ```
     root=PARTUUID=<Your-SSD-Root-PARTUUID> rootfstype=ext4 rootwait
     ```
   - For example, if the `PARTUUID` of the SSD's root partition is `e72d462f-02`, your `cmdline.txt` should include:
     ```
     root=PARTUUID=e72d462f-02 rootfstype=ext4 rootwait
     ```
   - Save and exit the file.

#### 2. Ensure Proper Mounting of the SSD

1. **Edit the `fstab` on the SSD**:
   - Ensure that the `/boot` partition on the SD card is still mounted correctly by adding or updating the `/boot` entry in the SSD’s `fstab` file:
     ```bash
     sudo nano /mnt/ssd_root/etc/fstab
     ```
   - Add the following line to mount the SD card's boot partition:
     ```
     PARTUUID=<Your-SD-Card-Boot-PARTUUID> /boot vfat defaults 0 2
     ```
   - Replace `<Your-SD-Card-Boot-PARTUUID>` with the actual `PARTUUID` of the SD card's boot partition. You can find this by running:
     ```bash
     sudo blkid /dev/mmcblk0p1
     ```
   - Ensure the root partition on the SSD is correctly listed as `/` in the `fstab` file.

2. **Unmount and Sync Changes**:
   - After editing, ensure all filesystems are properly unmounted and synced:
     ```bash
     sudo umount /mnt/ssd_root
     sudo sync
     ```

#### 3. Finalize the Setup

1. **Reboot the Raspberry Pi**:
   - With the updated `cmdline.txt` and `fstab`, reboot the Raspberry Pi:
     ```bash
     sudo reboot
     ```

2. **Verify the Boot Process**:
   - After rebooting, verify that the system has successfully booted using the SD card's boot partition but is running the root filesystem from the SSD:
     ```bash
     lsblk
     ```
   - Ensure that `/boot` is mounted from the SD card and `/` is mounted from the SSD.



````shell
#!/bin/bash

````

